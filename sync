#!/bin/bash

# Kolmogorov CV Production Sync Script
# For production server with PM2

set -e

echo "ðŸš€ Kolmogorov CV Production Sync"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Step 1: Git pull
print_status "Pulling latest changes..."
git pull https://github.com/onedal/kolmogorov-cv.git

# Step 2: Install dependencies
print_status "Installing dependencies..."
npm install

# Step 3: Build application
print_status "Building application..."
npm run build

# Step 4: Stop existing PM2 process
print_status "Stopping existing PM2 process..."
pm2 stop kolmogorov-cv 2>/dev/null || true
pm2 delete kolmogorov-cv 2>/dev/null || true
print_success "Existing processes stopped"

# Step 5: Start PM2 process
print_status "Starting PM2 process on port 3090..."
pm2 start ecosystem.config.cjs

# Step 6: Show status
print_status "PM2 Status:"
pm2 status

print_success "ðŸŽ‰ Production sync completed!"
print_status "Server running on: http://localhost:3090"
print_status "PM2 commands:"
print_status "  pm2 status          - Check status"
print_status "  pm2 logs kolmogorov-cv - View logs"
print_status "  pm2 restart kolmogorov-cv - Restart app"
print_status "  pm2 stop kolmogorov-cv - Stop app"